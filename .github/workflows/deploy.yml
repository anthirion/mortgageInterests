name: Unit tests, Static code analysis and deployment

on:
  push:
    branches:
      - master # Déclenche l'action lorsque du code est poussé sur master

jobs:
  # Job 1 : Tests unitaires
  unit-tests:
    runs-on: ubuntu-22.04
    steps:
      # Étape 1 : Checkout le dépôt
      - uses: actions/checkout@v3

      # Étape 2 : Installer Node.js pour Mocha et Chai
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # Étape 3 : Installer les dépendances (Mocha, Chai)
      - name: Install dependencies
        run: |
          npm install mocha chai

      # Étape 4 : Exécuter les tests unitaires
      - name: Run unit tests
        run: |
          npx mocha test/unit --reporter spec

  # Job 2 : Tests end-to-end avec Selenium
  e2e-tests:
    runs-on: ubuntu-22.04
    needs: unit-tests # Lance ce job seulement si les tests unitaires réussissent
    steps:
      # Étape 1 : Checkout le dépôt
      - uses: actions/checkout@v3

      # Étape 2 : Installer les dépendances Selenium
      - name: Setup Selenium & Node.js
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jdk
          npm install selenium-webdriver

      # Étape 3 : Exécuter les tests e2e
      - name: Run e2e tests
        run: |
          npx selenium-standalone start &
          sleep 5  # Attends un moment pour que Selenium se lance
          npx mocha test/e2e --reporter spec

  # Job 3 : Déploiement sur GitHub Pages
  # Copie des fichiers du dossier src/ et les déploie sur gh-pages
  deploy:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}

    steps:
      # Étape 1 : Checkout le dépôt
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Étape 2 : Copier les fichiers du dossier src vers le répertoire de déploiement
      - name: Copy files to deployment folder
        run: |
          mkdir output
          cp -r src/* output/

      # Étape 3 : Déployer sur la branche gh-pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./src
